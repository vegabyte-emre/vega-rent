version: '3.8'

services:
  superadmin_frontend:
    image: nginx:alpine
    container_name: superadmin_frontend
    restart: always
    volumes:
      - ./frontend/build:/usr/share/nginx/html:ro
      - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.superadmin-frontend.rule=Host(`${FRONTEND_DOMAIN}`)"
      - "traefik.http.routers.superadmin-frontend.entrypoints=websecure"
      - "traefik.http.routers.superadmin-frontend.tls.certresolver=letsencrypt"
      - "traefik.http.services.superadmin-frontend.loadbalancer.server.port=80"
    networks:
      - superadmin_network
      - traefik_network
    depends_on:
      - superadmin_backend

  superadmin_backend:
    image: python:3.11-slim
    container_name: superadmin_backend
    restart: always
    working_dir: /app
    volumes:
      - ./backend:/app
    command: >
      sh -c "pip install -r requirements.txt &&
             uvicorn server:app --host 0.0.0.0 --port 8001"
    environment:
      - MONGO_URL=mongodb://superadmin_mongodb:27017
      - DB_NAME=superadmin_db
      - JWT_SECRET=${JWT_SECRET:-supersecretkey123}
      - PORTAINER_URL=${PORTAINER_URL}
      - PORTAINER_API_KEY=${PORTAINER_API_KEY}
      - PORTAINER_ENDPOINT_ID=${PORTAINER_ENDPOINT_ID:-3}
      - IYZICO_API_KEY=${IYZICO_API_KEY:-}
      - IYZICO_SECRET_KEY=${IYZICO_SECRET_KEY:-}
      - IYZICO_BASE_URL=${IYZICO_BASE_URL:-https://sandbox-api.iyzipay.com}
      - FRONTEND_URL=https://${FRONTEND_DOMAIN}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.superadmin-backend.rule=Host(`${BACKEND_DOMAIN}`)"
      - "traefik.http.routers.superadmin-backend.entrypoints=websecure"
      - "traefik.http.routers.superadmin-backend.tls.certresolver=letsencrypt"
      - "traefik.http.services.superadmin-backend.loadbalancer.server.port=8001"
    networks:
      - superadmin_network
      - traefik_network
    depends_on:
      - superadmin_mongodb

  superadmin_mongodb:
    image: mongo:6
    container_name: superadmin_mongodb
    restart: always
    volumes:
      - superadmin_mongo_data:/data/db
    networks:
      - superadmin_network

networks:
  superadmin_network:
    driver: bridge
  traefik_network:
    external: true

volumes:
  superadmin_mongo_data:
    driver: local
